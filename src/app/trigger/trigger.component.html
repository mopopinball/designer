<div class="nestable-container" [class.active]="ruleEngine.active">
    <div class="header">
        <ng-container *ngIf="trigger.type === 'switch'">
            <mat-icon>close_fullscreen</mat-icon>
            <div class="title timer-title">
                <span class="title-text">Switch Trigger</span>
                <switch-selector [switchId]="trigger.switchId" (switchSelect)="trigger.switchId = $event"></switch-selector>
                <!-- <input type="text"
                    (input)="onSwitchChange($event)"
                    [ngModel]="trigger.switchId"
                    [matAutocomplete]="auto">
                <mat-autocomplete #auto="matAutocomplete" autoActiveFirstOption panelWidth="auto"
                    (optionSelected)="onSwSelected($event)"
                    (closed)="onSwClosed()"
                >
                    <mat-option *ngFor="let sw of filteredSwitches" [value]="sw.id">
                        {{sw.name}}
                    </mat-option>
                </mat-autocomplete> -->
                <input type="number" [(ngModel)]="trigger.holdIntervalMs" (ngModelChange)="onSwitchTriggerHoldTimeChange(trigger)" /> hold ms
            </div>
        </ng-container>
        <ng-container *ngIf="trigger.type === 'id'">
            <mat-icon>title</mat-icon>
            <div class="title">
                <span class="title-text">Named Trigger</span> <input [(ngModel)]="trigger.id" (ngModelChange)="gameService.update()" placeholder="Enter triger name" />
            </div>
        </ng-container>
        <ng-container *ngIf="trigger.type === 'timer'">
            <mat-icon>av_timer</mat-icon>
            <div class="title timer-title">
                <span class="title-text">Timer Trigger</span> <span class="id">{{trigger.id}}</span> <input type="number" [(ngModel)]="trigger.valueMs" (ngModelChange)="gameService.update()" />
                <span class="timer-mode" *ngIf="trigger.mode === TimerActionTriggerMode.TIMEOUT">timeout ms</span>
                <span class="timer-mode" *ngIf="trigger.mode === TimerActionTriggerMode.INTERVAL">interval ms</span>
                <mat-checkbox [ngModel]="trigger.mode === TimerActionTriggerMode.INTERVAL" [disabled]="!trigger.valueMs" (ngModelChange)="setTimerMode(trigger, $event)">Repeat</mat-checkbox>
            </div>
        </ng-container>
        <div class="spacer"></div>
        <button mat-icon-button [disabled]="!ruleEngine.active" title="Activate trigger">
            <mat-icon (click)="activateTrigger(trigger)">play_arrow</mat-icon>
        </button>
        <button mat-icon-button title="Move up" (click)="moveUp(trigger)" [disabled]="ruleEngine.triggers.indexOf(trigger) === 0">
            <mat-icon>vertical_align_top</mat-icon>
        </button>
        <button mat-icon-button title="Move down" (click)="moveDown(trigger)" [disabled]="ruleEngine.triggers.indexOf(trigger) === ruleEngine.triggers.length - 1">
            <mat-icon>vertical_align_bottom</mat-icon>
        </button>
        <button mat-icon-button title="Add action" [matMenuTriggerFor]="addactionmenu">
            <mat-icon>add_circle_outline</mat-icon>
        </button>
        <mat-menu #addactionmenu="matMenu">
            <button mat-menu-item (click)="addConditionalAction(trigger)" title="Calls a Trigger if all conditions are true, otherwise calls another Trigger">
                <mat-icon>call_split</mat-icon>
                <span>Conditional Action</span>
            </button>
            <button mat-menu-item (click)="addDataAction(trigger)" title="Assigns a value to the specified data entry">
                <mat-icon>label</mat-icon>
                <span>Data Action</span>
            </button>
            <button mat-menu-item (click)="addDeviceAction(trigger)" title="Sets a Device to a given state">
                <mat-icon>highlight</mat-icon>
                <span>Device Action</span>
            </button>
            <button mat-menu-item (click)="addNamedAction(trigger)" title="Calls a named Trigger">
                <mat-icon>title</mat-icon>
                <span>Named Action</span>
            </button>
            <button mat-menu-item (click)="addStateAction(trigger)" title="Starts/stops the given states">
                <mat-icon>group_work</mat-icon>
                <span>State Action</span>
            </button>
        </mat-menu>
        <button mat-icon-button title="Delete Trigger">
            <mat-icon (click)="deleteTrigger(trigger)">delete</mat-icon>
        </button>
    </div>
    <div class="body">
        <span class="no-items" *ngIf="!trigger.actions.length">No actions</span>
        <div *ngFor="let action of trigger.actions" class="actions">
            <div *ngIf="action.type === 'state'" class="action">
                <div class="title">
                    <ng-container *ngIf="!action.stopTargetId && action.startTargetId">Start State Action</ng-container>
                    <ng-container *ngIf="action.stopTargetId && !action.startTargetId">Stop State Action</ng-container>
                </div>
                <span>
                    <mat-icon>group_work</mat-icon><mat-icon>arrow_right_alt</mat-icon><mat-icon>group_work</mat-icon>
                </span>
                <span>
                    Stop: <input type="text" [(ngModel)]="action.stopTargetId" (ngModelChange)="gameService.update()" spellcheck="false" /> -> Start: <input type="text" [(ngModel)]="action.startTargetId" (ngModelChange)="gameService.update()" spellcheck="false" />
                </span>
                <div class="spacer"></div>
                <app-action-actions [trigger]="trigger" [action]="action" ></app-action-actions>
            </div>
            <named-action *ngIf="action.type === 'named'" [trigger]="trigger" [action]="action"></named-action>
            <div *ngIf="action.type === 'device'" class="action">
                <div class="title">Device Action</div>
                <app-desired-output-state [(state)]="action.state" [parentActive]="ruleEngine.active" [deleteable]="false"></app-desired-output-state>
                <div class="spacer"></div>
                <app-action-actions [trigger]="trigger" [action]="action" ></app-action-actions>
            </div>
            <div *ngIf="action.type === 'data' && action.expression === undefined" class="action">
                <div class="title">Data Action</div>
                <mat-icon>label</mat-icon>
                <app-data-key-selector class="token" [ruleEngine]="ruleEngine" [dataKey]="action.dataKey" (key)="action.dataKey = $event"></app-data-key-selector>
                <app-data-operation class="token" [operation]="action.operation" (changed)="action.operation = $event; gameService.update();"></app-data-operation>
                <app-operand-selector class="token" [ruleEngine]="ruleEngine" [(operand)]="action.operand" (operandChange)="gameService.update()"></app-operand-selector>
                <div class="spacer"></div>
                <app-action-actions [trigger]="trigger" [action]="action" ></app-action-actions>
            </div>
            <div *ngIf="action.type === 'data' && action.expression !== undefined" class="action">
                <div class="title">Data Action</div>
                <mat-icon>label</mat-icon>
                <app-data-key-selector class="token" [ruleEngine]="ruleEngine" [dataKey]="action.dataKey" (key)="action.dataKey = $event"></app-data-key-selector>
                =&nbsp;<input type="text" placeholder="Enter an expression" [(ngModel)]="action.expression" (ngModelChange)="gameService.update()" spellcheck="false" />
                <div class="spacer"></div>
                <app-action-actions [trigger]="trigger" [action]="action" ></app-action-actions>
            </div>
            <div *ngIf="action.type === 'condition'" class="action">
                <div class="title">Conditional Action</div>
                <mat-icon>call_split</mat-icon>
                <span class="token">If</span>
                <div>
                    <div *ngFor="let condition of action.conditions">
                        <div *ngIf="condition.conditionType === 'data' && condition.expression === undefined" class="condition">
                            Data:
                            <app-data-key-selector class="token" [ruleEngine]="ruleEngine" [dataKey]="condition.dataId" (key)="condition.dataId = $event"></app-data-key-selector>
                            <select class="token" [(ngModel)]="condition.operator">
                                <option *ngFor="let op of operators" [ngValue]="op">{{op}}</option>
                            </select>
                            <app-operand-selector class="token" [ruleEngine]="ruleEngine" [(operand)]="condition.operand" (change)="gameService.update()"></app-operand-selector>
                            <button (click)="deleteCondition(action, condition)">X</button>
                        </div>
                        <div *ngIf="condition.conditionType === 'data' && condition.expression !== undefined" class="condition">
                            Data:
                            <input type="text" [(ngModel)]="condition.expression" (ngModelChange)="gameService.update()" placeholder="Enter an expression" spellcheck="false" />
                            <button mat-icon-button title="Delete condition" (click)="deleteCondition(action, condition)" (ngModelChange)="gameService.update()">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <div *ngIf="condition.conditionType === 'switch'" class="condition">
                            Switch:
                            <!-- <input type="text" [(ngModel)]="condition.switchId" placeholder="Enter switch id" (ngModelChange)="gameService.update()" /> -->
                            <switch-selector [switchId]="condition.switchId" (switchSelect)="onSwitchConditionChanged(condition, $event)"></switch-selector>
                            <input type="checkbox" [(ngModel)]="condition.activated" /> Activated
                            <button mat-icon-button title="Delete condition" (click)="deleteCondition(action, condition)" (ngModelChange)="gameService.update()">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                    </div>
                    <span class="token">then trigger</span>
                    <input class="token" type="text" [(ngModel)]="action.trueTriggerId" (ngModelChange)="gameService.update()" placeholder="Enter a Trigger id" />
                    <span class="token">else trigger</span>
                    <input type="text" [(ngModel)]="action.falseTriggerId" (ngModelChange)="gameService.update()" placeholder="Enter a Trigger id" />
                </div>
                <div class="spacer"></div>
                <button mat-icon-button [matMenuTriggerFor]="addcondition" title="Add Condition">
                    <mat-icon>add_circle_outline</mat-icon>
                </button>
                <mat-menu #addcondition="matMenu">
                    <button mat-menu-item (click)="addDataCondition(action)">
                        <mat-icon>label</mat-icon>
                        <span>Data Condition</span>
                    </button>
                    <button mat-menu-item (click)="addSwitchCondition(action)">
                        <mat-icon>bolt</mat-icon>
                        <span>Switch Condition</span>
                    </button>
                </mat-menu>
                <app-action-actions [trigger]="trigger" [action]="action" ></app-action-actions>
            </div>
        </div>
    </div>
</div>